name: Create Test Taps

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network'
        required: true
        type: choice
        options:
          - base-sepolia
          - base
      count:
        description: 'Number of test taps to create'
        required: true
        default: '5'

jobs:
  create-taps:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Read deployment addresses
        id: addresses
        run: |
          REGISTRY=$(cat deployments/${{ inputs.network }}.json | jq -r '.TapRegistry.proxy')
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Create test taps
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          BASE_SEPOLIA_RPC_URL: ${{ secrets.BASE_SEPOLIA_RPC_URL }}
          BASE_RPC_URL: ${{ secrets.BASE_RPC_URL }}
        run: |
          if [ "${{ inputs.network }}" == "base-sepolia" ]; then
            RPC_URL=$BASE_SEPOLIA_RPC_URL
          else
            RPC_URL=$BASE_RPC_URL
          fi
          
          REGISTRY="${{ steps.addresses.outputs.registry }}"
          
          for i in $(seq 1 ${{ inputs.count }}); do
            echo "Creating tap $i..."
            cast send $REGISTRY \
              "createTapETH(address,uint256,uint256,uint256,bool)" \
              "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb" \
              "$(($i * 100000000000000000))" \
              "3600" \
              "10" \
              "false" \
              --rpc-url $RPC_URL \
              --private-key $PRIVATE_KEY
            
            sleep 2
          done

      - name: Summary
        run: |
          echo "## Test Taps Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Count:** ${{ inputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ steps.addresses.outputs.registry }}" >> $GITHUB_STEP_SUMMARY
